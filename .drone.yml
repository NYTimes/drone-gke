---
workspace:
  base: /go
  path: src/github.com/nytimes/drone-gke

build_config: &build_config
  image: golang:1
  environment:
    - GO111MODULE=on
    - GOPROXY=https://proxy.golang.org
    - CGO_ENABLED=0
  commands:
    - go build -a -ldflags "-X main.version=${DRONE_TAG:-other} -X main.rev=${DRONE_COMMIT}"

publish_config: &publish_config
  image: plugins/docker
  repo: nytimes/drone-gke
  dockerfile: Dockerfile
  secrets:
    - docker_username
    - docker_password

pipeline:
  test:
    image: golang:1
    environment:
      - GO111MODULE=on
      - GOPROXY=https://proxy.golang.org
      - CGO_ENABLED=0
    commands:
      - go mod download
      - go test -cover -vet all

  build:
    <<: *build_config
    when:
      branch:
        - develop
        - master

  build_release:
    <<: *build_config
    when:
      event: tag

  publish_develop:
    <<: *publish_config
    build_args:
    - GCLOUD_SDK_TAG=alpine
    tag:
      - "develop"
    when:
      event: push
      branch: develop

  publish_latest:
    <<: *publish_config
    build_args:
    - GCLOUD_SDK_TAG=alpine
    auto_tag: true

  publish_1_10:
    <<: *publish_config
    build_args:
    - GCLOUD_SDK_TAG=217.0.0-alpine
    auto_tag: true
    auto_tag_suffix: "k8s-1.10"

  publish_1_11:
    <<: *publish_config
    build_args:
    - GCLOUD_SDK_TAG=241.0.0-alpine
    auto_tag: true
    auto_tag_suffix: "k8s-1.11"

  slack:
    image: plugins/slack
    channel: dv-notifications
    secrets:
      - slack_webhook
    when:
      branch:
        - develop
        - master

  slack_tag:
    image: plugins/slack
    channel: dv-notifications
    secrets:
      - slack_webhook
    when:
      event:
        - tag
